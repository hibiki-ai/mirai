<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mirai - Torch Integration • mirai</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="mirai - Torch Integration">
<meta property="og:description" content="mirai">
<meta property="og:image" content="https://shikokuchuo.net/mirai/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mirai</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.11.3.9004</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/mirai.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/parallel.html">mirai - Parallel Integration</a>
    </li>
    <li>
      <a href="../articles/plumber.html">mirai - Plumber Integration</a>
    </li>
    <li>
      <a href="../articles/shiny.html">mirai - Shiny Integration</a>
    </li>
    <li>
      <a href="../articles/torch.html">mirai - Torch Integration</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/shikokuchuo/mirai/" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://shikokuchuo.net/" class="external-link">
    <span class="fa fa-cube"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>mirai - Torch Integration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shikokuchuo/mirai/blob/HEAD/vignettes/torch.Rmd" class="external-link"><code>vignettes/torch.Rmd</code></a></small>
      <div class="hidden name"><code>torch.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="torch-integration">Torch Integration<a class="anchor" aria-label="anchor" href="#torch-integration"></a>
</h3>
<p>Custom serialization functions may be registered to handle external
pointer type reference objects.</p>
<p>This allows tensors from the <a href="https://cran.r-project.org/package=torch" class="external-link"><code>torch</code></a>
package to be used seamlessly in ‘mirai’ computations.</p>
<ol style="list-style-type: decimal">
<li><p>Register the serialization and unserialization functions as a
list supplied to the ‘refhook’ argument of
<code><a href="../reference/serialization.html">serialization()</a></code>.</p></li>
<li><p>Set up dameons - this may be done before or after setting
<code><a href="../reference/serialization.html">serialization()</a></code>.</p></li>
<li><p>Use <code><a href="../reference/everywhere.html">everywhere()</a></code> to make the ‘torch’ package
available on all dameons (for convenience, optional).</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/serialization.html">serialization</a></span><span class="op">(</span>refhook <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">torch</span><span class="fu">:::</span><span class="va">torch_serialize</span>, <span class="fu">torch</span><span class="fu">::</span><span class="va">torch_load</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="../reference/everywhere.html">everywhere</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The below example creates a convolutional neural network using
<code>torch::nn_module()</code>, which is then passed a set of
parameters and initialized within a ‘mirai’.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">nn_module</span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv1</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">conv2</span> <span class="op">&lt;-</span> <span class="fu">nn_conv2d</span><span class="op">(</span><span class="va">in_size</span>, <span class="va">out_size</span>, <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv1</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">conv2</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">nnf_relu</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>in_size <span class="op">=</span> <span class="fl">1</span>, out_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span>, .args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">params</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/call_mirai.html">call_mirai</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="co">#&gt; An `nn_module` containing 1,040 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Modules ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; • conv1: &lt;nn_conv2d&gt; #520 parameters</span></span>
<span><span class="co">#&gt; • conv2: &lt;nn_conv2d&gt; #520 parameters</span></span></code></pre></div>
<p>The returned model is an object containing many tensor elements.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">conv1.weight</span></span>
<span><span class="co">#&gt; torch_tensor</span></span>
<span><span class="co">#&gt; (1,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1205 -0.1757 -0.0501  0.1389  0.0922</span></span>
<span><span class="co">#&gt;  -0.1649 -0.1273  0.0191  0.1186 -0.0943</span></span>
<span><span class="co">#&gt;   0.1665 -0.0876 -0.1023  0.0301  0.1141</span></span>
<span><span class="co">#&gt;   0.0322  0.0580  0.0123 -0.0415 -0.1614</span></span>
<span><span class="co">#&gt;   0.1639  0.1523 -0.1057 -0.0188 -0.0248</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (2,1,.,.) = </span></span>
<span><span class="co">#&gt;  -0.1008  0.1984 -0.0736 -0.1917  0.1427</span></span>
<span><span class="co">#&gt;   0.0703  0.0128  0.0620 -0.0524 -0.0565</span></span>
<span><span class="co">#&gt;   0.0750 -0.0657  0.1786 -0.1733 -0.0639</span></span>
<span><span class="co">#&gt;  -0.1578  0.1989  0.1473 -0.1071  0.0607</span></span>
<span><span class="co">#&gt;  -0.1334 -0.1061 -0.1487 -0.1097 -0.0244</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (3,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.0814  0.1406  0.0929  0.0101  0.0254</span></span>
<span><span class="co">#&gt;   0.0645  0.0082 -0.1432 -0.0091 -0.1674</span></span>
<span><span class="co">#&gt;   0.0242 -0.1321 -0.1690 -0.0254 -0.1345</span></span>
<span><span class="co">#&gt;  -0.1011  0.0083 -0.1139 -0.0948 -0.0941</span></span>
<span><span class="co">#&gt;  -0.0352 -0.1540  0.0097 -0.1977  0.0735</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (4,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.1920  0.1211  0.1399  0.1913 -0.0115</span></span>
<span><span class="co">#&gt;  -0.1858  0.0491 -0.0151 -0.0219 -0.1164</span></span>
<span><span class="co">#&gt;  -0.1854  0.0309 -0.0076  0.0381 -0.0900</span></span>
<span><span class="co">#&gt;   0.0488  0.1269  0.0352  0.0338 -0.0510</span></span>
<span><span class="co">#&gt;  -0.0565 -0.0516 -0.0590  0.1656 -0.1994</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; (5,1,.,.) = </span></span>
<span><span class="co">#&gt;   0.1760 -0.0951 -0.0583  0.1938  0.0130</span></span>
<span><span class="co">#&gt; ... [the output was truncated (use n=-1 to disable)]</span></span>
<span><span class="co">#&gt; [ CPUFloatType{20,1,5,5} ][ requires_grad = TRUE ]</span></span></code></pre></div>
<p>The model parameters can then be further passed to an optimiser, with
that also initialized within a ‘mirai’ process.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mirai.html">mirai</a></span><span class="op">(</span><span class="fu">optim_rmsprop</span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span><span class="op">)</span>, params <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">parameters</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/call_mirai.html">call_mirai</a></span><span class="op">(</span><span class="va">optim</span><span class="op">)</span><span class="op">$</span><span class="va">data</span></span>
<span><span class="co">#&gt; &lt;optim_rmsprop&gt;</span></span>
<span><span class="co">#&gt;   Inherits from: &lt;torch_optimizer&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     add_param_group: function (param_group) </span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     defaults: list</span></span>
<span><span class="co">#&gt;     initialize: function (params, lr = 0.01, alpha = 0.99, eps = 1e-08, weight_decay = 0, </span></span>
<span><span class="co">#&gt;     load_state_dict: function (state_dict, ..., .refer_to_state_dict = FALSE) </span></span>
<span><span class="co">#&gt;     param_groups: list</span></span>
<span><span class="co">#&gt;     state: State, R6</span></span>
<span><span class="co">#&gt;     state_dict: function () </span></span>
<span><span class="co">#&gt;     step: function (closure = NULL) </span></span>
<span><span class="co">#&gt;     zero_grad: function () </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     step_helper: function (closure, loop_fun)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/daemons.html">daemons</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>Above, tensors and complex objects containing tensors were passed
seamlessly between host and daemon processes, in the same way as any
other R object.</p>
<p>The implementation leverages R’s own native ‘refhook’ mechanism to
allow such completely transparent usage, and is designed to be fast and
efficient using the serialization methods from the ‘torch’ package
directly, minimising data copies where possible.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Charlie Gao.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
